#!/bin/bash
# KAMS Science Curriculum - Pre-commit Hook
#
# This hook runs validation before each commit to enforce:
# 1. Protected file rules (production content)
# 2. Cycle-status.json schema compliance
# 3. Point total validation (100 pts/week)
#
# Installation:
#   git config core.hooksPath .githooks
#
# To bypass (emergency only):
#   git commit --no-verify -m "EMERGENCY: <reason>"

set -e

echo "ğŸ” Running pre-commit validations..."
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# ----------------------------------------------------------------------------
# 1. Protected Files Check
# ----------------------------------------------------------------------------
echo "Checking protected files..."

if [ -f "scripts/validate-protected-files.js" ]; then
    if ! node scripts/validate-protected-files.js --staged; then
        ERRORS=$((ERRORS + 1))
    fi
else
    echo -e "${YELLOW}âš ï¸  validate-protected-files.js not found, skipping${NC}"
fi

# ----------------------------------------------------------------------------
# 2. Cycle Status Schema Validation
# ----------------------------------------------------------------------------
echo ""
echo "Validating cycle-status.json files..."

# Check if any cycle-status.json files are staged
STAGED_STATUS_FILES=$(git diff --cached --name-only | grep "cycle-status.json" || true)

if [ -n "$STAGED_STATUS_FILES" ]; then
    if [ -f "scripts/validate-cycle-status.js" ]; then
        if ! node scripts/validate-cycle-status.js; then
            echo -e "${RED}âŒ Cycle status validation failed${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    else
        echo -e "${YELLOW}âš ï¸  validate-cycle-status.js not found, skipping${NC}"
    fi
else
    echo -e "${GREEN}âœ“ No cycle-status.json files staged${NC}"
fi

# ----------------------------------------------------------------------------
# 3. Config Validation
# ----------------------------------------------------------------------------
echo ""
echo "Validating configuration..."

if [ -f "scripts/validate-config.js" ]; then
    if ! node scripts/validate-config.js 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  Config validation had warnings${NC}"
        # Don't fail on config warnings, just notify
    fi
else
    echo -e "${GREEN}âœ“ Config validation skipped (validator not found)${NC}"
fi

# ----------------------------------------------------------------------------
# 4. Check for debug/test artifacts
# ----------------------------------------------------------------------------
echo ""
echo "Checking for debug artifacts..."

# Look for common debug patterns in staged files
STAGED_FILES=$(git diff --cached --name-only)
DEBUG_PATTERNS="console\.log\(|debugger;|TODO:|FIXME:|HACK:"

DEBUG_FOUND=false
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Skip non-text files and specific directories
        case "$file" in
            *.json|*.md|*.txt|node_modules/*|.git/*)
                continue
                ;;
        esac

        if grep -qE "$DEBUG_PATTERNS" "$file" 2>/dev/null; then
            if [ "$DEBUG_FOUND" = false ]; then
                echo -e "${YELLOW}âš ï¸  Debug artifacts found (review before commit):${NC}"
                DEBUG_FOUND=true
            fi
            echo "   $file"
        fi
    fi
done

if [ "$DEBUG_FOUND" = false ]; then
    echo -e "${GREEN}âœ“ No debug artifacts detected${NC}"
fi

# ----------------------------------------------------------------------------
# Summary
# ----------------------------------------------------------------------------
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âŒ Pre-commit validation FAILED${NC}"
    echo ""
    echo "To fix:"
    echo "  1. Address the errors above"
    echo "  2. Stage your fixes: git add <files>"
    echo "  3. Try commit again"
    echo ""
    echo "To bypass (emergency only):"
    echo "  git commit --no-verify -m \"EMERGENCY: <reason>\""
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ“ All pre-commit validations passed${NC}"
    echo ""
    exit 0
fi
