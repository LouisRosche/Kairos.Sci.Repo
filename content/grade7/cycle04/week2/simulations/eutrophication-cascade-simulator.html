<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive simulation showing how nutrient runoff causes eutrophication and dead zones">
    <title>Eutrophication Cascade Simulator | G7 C4 W2</title>
    <!--
    ================================================================================
    Eutrophication Cascade Simulator
    ================================================================================
    Interactive simulation demonstrating:
    - Nutrient runoff (N, P) causing algae blooms
    - The eutrophication cascade: nutrients ‚Üí algae ‚Üí decomposition ‚Üí hypoxia
    - Dead zone formation and effects on marine life
    - Real Gulf of Mexico data (1985-2024)
    - Remediation intervention testing

    Part of Grade 7 Cycle 4 Week 2: Eutrophication & Dead Zones
    Standards: MS-ESS3-3 (Monitoring Human Impact)
    ================================================================================
    -->
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #D1FAE5;
            --algae: #84CC16;
            --algae-bloom: #65A30D;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --error: #DC2626;
            --error-light: #FEE2E2;
            --water-healthy: #0EA5E9;
            --water-hypoxic: #475569;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --text: #1E293B;
            --text-muted: #64748B;
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #047857 0%, #065F46 100%);
            min-height: 100vh;
            padding: 12px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 {
            color: white;
            text-align: center;
            font-size: clamp(1.4em, 4vw, 2em);
            margin-bottom: 8px;
        }

        .subtitle {
            color: rgba(255,255,255,0.85);
            text-align: center;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            margin-bottom: 20px;
        }

        .sim-container {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Instructions */
        .instructions {
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        .instructions summary {
            padding: 14px 18px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-dark);
            list-style: none;
        }

        .instructions summary::-webkit-details-marker { display: none; }
        .instructions[open] summary { border-bottom: 1px solid rgba(5,150,105,0.2); }

        .instructions-content {
            padding: 16px 18px;
            font-size: 0.95em;
            line-height: 1.7;
            color: var(--gray-700);
        }

        .instructions-content ol { padding-left: 20px; }
        .instructions-content li { margin-bottom: 8px; }

        /* Main Grid */
        .sim-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 800px) {
            .sim-grid { grid-template-columns: 1fr; }
        }

        /* Control Panel */
        .control-panel {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: 20px;
            border: 2px solid var(--gray-200);
        }

        .control-panel h3 {
            color: var(--primary-dark);
            margin-bottom: 16px;
            font-size: 1.1em;
        }

        .control-group { margin-bottom: 20px; }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .control-value {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.85em;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
            border: 2px solid var(--gray-200);
        }

        .stat-card.warning { border-color: var(--warning); background: var(--warning-light); }
        .stat-card.danger { border-color: var(--error); background: var(--error-light); }
        .stat-card.good { border-color: var(--primary); background: var(--primary-light); }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--gray-900);
        }

        /* Lake Visualization */
        .lake-container {
            background: linear-gradient(180deg, #87CEEB 0%, #0EA5E9 20%, #0284C7 100%);
            border-radius: var(--radius-sm);
            min-height: 320px;
            position: relative;
            overflow: hidden;
            transition: background 0.5s ease;
        }

        .lake-container.algae-low {
            background: linear-gradient(180deg, #87CEEB 0%, #0EA5E9 20%, #0284C7 100%);
        }

        .lake-container.algae-medium {
            background: linear-gradient(180deg, #A7F3D0 0%, #34D399 30%, #059669 100%);
        }

        .lake-container.algae-high {
            background: linear-gradient(180deg, #BEF264 0%, #84CC16 30%, #65A30D 100%);
        }

        .lake-container.dead-zone {
            background: linear-gradient(180deg, #84CC16 0%, #65A30D 20%, #475569 60%, #1E293B 100%);
        }

        /* Nutrient Input Animation */
        .nutrient-stream {
            position: absolute;
            top: 0;
            left: 20%;
            width: 60%;
            height: 40px;
            overflow: hidden;
        }

        .nutrient-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: fall 2s infinite linear;
        }

        .nutrient-particle.nitrogen { background: #3B82F6; }
        .nutrient-particle.phosphorus { background: #F59E0B; }

        @keyframes fall {
            0% { transform: translateY(-20px); opacity: 1; }
            100% { transform: translateY(60px); opacity: 0; }
        }

        /* Algae Particles */
        .algae-layer {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            height: 100px;
            overflow: hidden;
        }

        .algae-blob {
            position: absolute;
            background: rgba(132, 204, 22, 0.6);
            border-radius: 50%;
            animation: float 4s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        /* Organisms */
        .organisms-row {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
        }

        .organism {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius-sm);
            padding: 10px;
            text-align: center;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        .organism.healthy { border: 3px solid var(--primary); }
        .organism.stressed { border: 3px solid var(--warning); }
        .organism.dead { border: 3px solid var(--error); opacity: 0.6; }

        .organism-emoji {
            font-size: 2em;
            transition: filter 0.3s ease;
        }

        .organism.dead .organism-emoji { filter: grayscale(100%); }

        .organism-name { font-size: 0.75em; font-weight: 600; color: var(--gray-700); }

        /* Cascade Diagram */
        .cascade-section {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
        }

        .cascade-section h4 {
            color: var(--primary-dark);
            margin-bottom: 16px;
        }

        .cascade-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cascade-step {
            background: white;
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            text-align: center;
            border: 2px solid var(--gray-200);
            flex: 1;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .cascade-step.active {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .cascade-step.warning {
            border-color: var(--warning);
            background: var(--warning-light);
        }

        .cascade-step.danger {
            border-color: var(--error);
            background: var(--error-light);
        }

        .cascade-step .emoji { font-size: 1.5em; margin-bottom: 4px; }
        .cascade-step .label { font-size: 0.8em; font-weight: 600; color: var(--gray-700); }

        .cascade-arrow {
            font-size: 1.5em;
            color: var(--gray-400);
        }

        @media (max-width: 600px) {
            .cascade-flow { flex-direction: column; }
            .cascade-arrow { transform: rotate(90deg); }
        }

        /* Data Section */
        .data-section {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
        }

        .data-section h4 {
            color: var(--primary-dark);
            margin-bottom: 16px;
        }

        .data-chart {
            background: white;
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--gray-200);
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            gap: 4px;
            padding: 10px 0;
            border-bottom: 2px solid var(--gray-300);
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .bar {
            width: 100%;
            max-width: 30px;
            background: var(--error);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
        }

        .bar-label {
            font-size: 0.65em;
            color: var(--text-muted);
            transform: rotate(-45deg);
            white-space: nowrap;
        }

        .chart-note {
            text-align: center;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 12px;
        }

        /* Quiz */
        .quiz-section {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: 20px;
            border: 2px solid var(--gray-200);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .quiz-header h4 { color: var(--gray-900); }

        .reset-btn {
            background: var(--gray-200);
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--gray-700);
        }

        .reset-btn:hover { background: var(--gray-300); }

        .quiz-question { margin-bottom: 16px; }
        .quiz-question p { margin-bottom: 12px; color: var(--gray-700); line-height: 1.6; }

        .quiz-options { display: grid; gap: 8px; }

        .quiz-btn {
            background: white;
            border: 2px solid var(--gray-300);
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .quiz-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .quiz-btn.correct { background: var(--primary-light); border-color: var(--primary); }
        .quiz-btn.incorrect { background: var(--error-light); border-color: var(--error); }
        .quiz-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        .quiz-feedback {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
            display: none;
        }

        .quiz-feedback.show { display: block; }
        .quiz-feedback.correct { background: var(--primary-light); color: #065F46; }
        .quiz-feedback.incorrect { background: var(--error-light); color: #991B1B; }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        button:focus, input:focus { outline: 3px solid var(--primary); outline-offset: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåø Eutrophication Cascade Simulator</h1>
        <p class="subtitle">See how nutrient runoff creates dead zones</p>

        <div class="sim-container">
            <!-- Instructions -->
            <details class="instructions" open>
                <summary role="button" aria-expanded="true">üìã How to Use This Simulation</summary>
                <div class="instructions-content">
                    <ol>
                        <li><strong>Adjust nutrient input</strong> to simulate fertilizer runoff levels</li>
                        <li><strong>Watch the cascade</strong> ‚Äî nutrients ‚Üí algae bloom ‚Üí decomposition ‚Üí dead zone</li>
                        <li><strong>Observe oxygen levels</strong> and how organisms respond</li>
                        <li><strong>Study the real data</strong> from the Gulf of Mexico dead zone</li>
                        <li><strong>Test your understanding</strong> with the quiz</li>
                    </ol>
                </div>
            </details>

            <!-- Main Simulation -->
            <div class="sim-grid">
                <!-- Control Panel -->
                <div class="control-panel">
                    <h3>üéõÔ∏è Nutrient Controls</h3>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Fertilizer Runoff</span>
                            <span class="control-value" id="nutrient-display">50%</span>
                        </div>
                        <input type="range" id="nutrient-slider" min="0" max="100" value="50"
                               aria-label="Adjust nutrient runoff level">
                        <div class="range-labels">
                            <span>Low</span>
                            <span>High</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card" id="algae-card">
                            <div class="stat-label">Algae Level</div>
                            <div class="stat-value" id="algae-display">Medium</div>
                        </div>
                        <div class="stat-card" id="oxygen-card">
                            <div class="stat-label">Oxygen (mg/L)</div>
                            <div class="stat-value" id="oxygen-display">6.0</div>
                        </div>
                    </div>

                    <div class="stat-card" id="status-card" style="margin-bottom: 16px;">
                        <div class="stat-label">Ecosystem Status</div>
                        <div class="stat-value" id="status-display">Stressed</div>
                    </div>

                    <!-- Legend -->
                    <div style="background: white; border-radius: var(--radius-sm); padding: 12px; border: 1px solid var(--gray-200);">
                        <div style="font-size: 0.85em; font-weight: 600; margin-bottom: 8px;">Oxygen Thresholds:</div>
                        <div style="font-size: 0.8em; color: var(--text-muted);">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <span style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%;"></span>
                                &gt;6 mg/L: Healthy
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <span style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></span>
                                2-6 mg/L: Stressed
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="width: 12px; height: 12px; background: var(--error); border-radius: 50%;"></span>
                                &lt;2 mg/L: Dead Zone
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lake Visualization -->
                <div class="lake-container algae-medium" id="lake">
                    <div class="nutrient-stream" id="nutrient-stream"></div>
                    <div class="algae-layer" id="algae-layer"></div>

                    <div class="organisms-row">
                        <div class="organism stressed" id="fish-card">
                            <div class="organism-emoji">üêü</div>
                            <div class="organism-name">Fish</div>
                        </div>
                        <div class="organism stressed" id="crab-card">
                            <div class="organism-emoji">ü¶Ä</div>
                            <div class="organism-name">Crabs</div>
                        </div>
                        <div class="organism stressed" id="shrimp-card">
                            <div class="organism-emoji">ü¶ê</div>
                            <div class="organism-name">Shrimp</div>
                        </div>
                        <div class="organism healthy" id="bacteria-card">
                            <div class="organism-emoji">ü¶†</div>
                            <div class="organism-name">Bacteria</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cascade Diagram -->
            <div class="cascade-section">
                <h4>üîÑ The Eutrophication Cascade</h4>
                <div class="cascade-flow">
                    <div class="cascade-step active" id="step-nutrients">
                        <div class="emoji">üß™</div>
                        <div class="label">Nutrient Runoff</div>
                    </div>
                    <div class="cascade-arrow">‚Üí</div>
                    <div class="cascade-step" id="step-algae">
                        <div class="emoji">üåø</div>
                        <div class="label">Algae Bloom</div>
                    </div>
                    <div class="cascade-arrow">‚Üí</div>
                    <div class="cascade-step" id="step-death">
                        <div class="emoji">üíÄ</div>
                        <div class="label">Algae Dies</div>
                    </div>
                    <div class="cascade-arrow">‚Üí</div>
                    <div class="cascade-step" id="step-decomp">
                        <div class="emoji">ü¶†</div>
                        <div class="label">Decomposition</div>
                    </div>
                    <div class="cascade-arrow">‚Üí</div>
                    <div class="cascade-step" id="step-hypoxia">
                        <div class="emoji">‚ö†Ô∏è</div>
                        <div class="label">Oxygen Depleted</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 12px; font-size: 0.9em; color: var(--text-muted);">
                    <strong>Positive Feedback:</strong> More nutrients ‚Üí more algae ‚Üí more decomposition ‚Üí less oxygen ‚Üí more dead organisms ‚Üí more decomposition!
                </p>
            </div>

            <!-- Real Data Section -->
            <div class="data-section">
                <h4>üìä Gulf of Mexico Dead Zone (1985-2024)</h4>
                <div class="data-chart">
                    <div class="chart-bars" id="chart-bars">
                        <!-- Generated by JavaScript -->
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: var(--text-muted); margin-top: 4px;">
                        <span>1985</span>
                        <span>1995</span>
                        <span>2005</span>
                        <span>2015</span>
                        <span>2024</span>
                    </div>
                </div>
                <p class="chart-note">
                    Dead zone size in km¬≤ ‚Äî Peak in 2017 at <strong>22,720 km¬≤</strong> (about the size of New Jersey!)
                </p>
            </div>

            <!-- Quiz Section -->
            <div class="quiz-section">
                <div class="quiz-header">
                    <h4>‚úÖ Check Your Understanding</h4>
                    <button class="reset-btn" onclick="resetQuiz()">Try Again</button>
                </div>

                <div class="quiz-question">
                    <p><strong>Q1:</strong> What is the CORRECT order of the eutrophication cascade?</p>
                    <div class="quiz-options" role="group">
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 1)">Algae bloom ‚Üí Nutrient runoff ‚Üí Dead zone ‚Üí Decomposition</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, true, 1)">Nutrient runoff ‚Üí Algae bloom ‚Üí Decomposition ‚Üí Oxygen depletion</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 1)">Oxygen depletion ‚Üí Decomposition ‚Üí Algae bloom ‚Üí Nutrient runoff</button>
                    </div>
                    <div class="quiz-feedback" id="feedback-1" role="alert"></div>
                </div>

                <div class="quiz-question">
                    <p><strong>Q2:</strong> Why does decomposition cause oxygen depletion?</p>
                    <div class="quiz-options" role="group">
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 2)">Dead algae releases toxic chemicals that destroy oxygen</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, true, 2)">Bacteria consume oxygen while breaking down dead algae</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 2)">Sunlight can't reach the water, stopping oxygen production</button>
                    </div>
                    <div class="quiz-feedback" id="feedback-2" role="alert"></div>
                </div>

                <div class="quiz-question">
                    <p><strong>Q3:</strong> Why is eutrophication considered a POSITIVE feedback loop?</p>
                    <div class="quiz-options" role="group">
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 3)">Because it has positive effects on the ecosystem</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, false, 3)">Because the changes are temporary and reverse naturally</button>
                        <button class="quiz-btn" onclick="checkAnswer(this, true, 3)">Because dead organisms create more decomposition, making the problem worse</button>
                    </div>
                    <div class="quiz-feedback" id="feedback-3" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gulf of Mexico dead zone data (km¬≤)
        const deadZoneData = [
            { year: 1985, size: 8774 },
            { year: 1988, size: 3968 },
            { year: 1991, size: 10500 },
            { year: 1994, size: 15500 },
            { year: 1997, size: 16000 },
            { year: 1999, size: 20000 },
            { year: 2002, size: 22000 },
            { year: 2005, size: 11840 },
            { year: 2008, size: 20720 },
            { year: 2011, size: 17520 },
            { year: 2014, size: 13080 },
            { year: 2017, size: 22720 },
            { year: 2019, size: 18005 },
            { year: 2021, size: 16405 },
            { year: 2024, size: 15250 }
        ];

        // Generate data chart
        function generateChart() {
            const container = document.getElementById('chart-bars');
            const maxSize = 23000;

            container.innerHTML = deadZoneData.map(d => {
                const height = (d.size / maxSize) * 130;
                return `
                    <div class="bar-group">
                        <div class="bar" style="height: ${height}px;" title="${d.year}: ${d.size.toLocaleString()} km¬≤"></div>
                        <div class="bar-label">${d.year}</div>
                    </div>
                `;
            }).join('');
        }

        // Calculate ecosystem state based on nutrient level
        function getEcosystemState(nutrientLevel) {
            if (nutrientLevel < 20) {
                return {
                    algae: 'Low',
                    oxygen: 8.0,
                    status: 'Healthy',
                    lakeClass: 'algae-low',
                    algaeCard: 'good',
                    oxygenCard: 'good',
                    statusCard: 'good',
                    organisms: { fish: 'healthy', crab: 'healthy', shrimp: 'healthy', bacteria: 'healthy' },
                    cascade: [true, false, false, false, false]
                };
            } else if (nutrientLevel < 50) {
                return {
                    algae: 'Medium',
                    oxygen: 6.0,
                    status: 'Stressed',
                    lakeClass: 'algae-medium',
                    algaeCard: 'warning',
                    oxygenCard: 'warning',
                    statusCard: 'warning',
                    organisms: { fish: 'stressed', crab: 'stressed', shrimp: 'stressed', bacteria: 'healthy' },
                    cascade: [true, true, false, false, false]
                };
            } else if (nutrientLevel < 75) {
                return {
                    algae: 'High',
                    oxygen: 3.5,
                    status: 'Critical',
                    lakeClass: 'algae-high',
                    algaeCard: 'danger',
                    oxygenCard: 'warning',
                    statusCard: 'danger',
                    organisms: { fish: 'stressed', crab: 'stressed', shrimp: 'dead', bacteria: 'healthy' },
                    cascade: [true, true, true, true, false]
                };
            } else {
                return {
                    algae: 'Bloom!',
                    oxygen: 1.2,
                    status: 'Dead Zone',
                    lakeClass: 'dead-zone',
                    algaeCard: 'danger',
                    oxygenCard: 'danger',
                    statusCard: 'danger',
                    organisms: { fish: 'dead', crab: 'dead', shrimp: 'dead', bacteria: 'healthy' },
                    cascade: [true, true, true, true, true]
                };
            }
        }

        // Update simulation
        function updateSimulation(nutrientLevel) {
            const state = getEcosystemState(nutrientLevel);

            // Update displays
            document.getElementById('nutrient-display').textContent = nutrientLevel + '%';
            document.getElementById('algae-display').textContent = state.algae;
            document.getElementById('oxygen-display').textContent = state.oxygen.toFixed(1);
            document.getElementById('status-display').textContent = state.status;

            // Update card colors
            document.getElementById('algae-card').className = 'stat-card ' + state.algaeCard;
            document.getElementById('oxygen-card').className = 'stat-card ' + state.oxygenCard;
            document.getElementById('status-card').className = 'stat-card ' + state.statusCard;

            // Update lake visualization
            document.getElementById('lake').className = 'lake-container ' + state.lakeClass;

            // Update organisms
            ['fish', 'crab', 'shrimp', 'bacteria'].forEach(org => {
                document.getElementById(org + '-card').className = 'organism ' + state.organisms[org];
            });

            // Update cascade steps
            const cascadeIds = ['step-nutrients', 'step-algae', 'step-death', 'step-decomp', 'step-hypoxia'];
            const cascadeColors = ['active', 'active', 'warning', 'warning', 'danger'];

            cascadeIds.forEach((id, i) => {
                const el = document.getElementById(id);
                el.className = 'cascade-step' + (state.cascade[i] ? ' ' + cascadeColors[i] : '');
            });

            // Update nutrient particles
            updateNutrientStream(nutrientLevel);

            // Update algae blobs
            updateAlgaeLayer(nutrientLevel);
        }

        // Create nutrient particles
        function updateNutrientStream(level) {
            const stream = document.getElementById('nutrient-stream');
            stream.innerHTML = '';

            const particleCount = Math.floor(level / 10);
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'nutrient-particle ' + (Math.random() > 0.5 ? 'nitrogen' : 'phosphorus');
                particle.style.left = (Math.random() * 100) + '%';
                particle.style.animationDelay = (Math.random() * 2) + 's';
                stream.appendChild(particle);
            }
        }

        // Create algae blobs
        function updateAlgaeLayer(level) {
            const layer = document.getElementById('algae-layer');
            layer.innerHTML = '';

            if (level < 20) return;

            const blobCount = Math.floor(level / 8);
            for (let i = 0; i < blobCount; i++) {
                const blob = document.createElement('div');
                blob.className = 'algae-blob';
                const size = 15 + Math.random() * 30;
                blob.style.width = size + 'px';
                blob.style.height = size + 'px';
                blob.style.left = (Math.random() * 90) + '%';
                blob.style.top = (Math.random() * 70) + '%';
                blob.style.animationDelay = (Math.random() * 4) + 's';
                layer.appendChild(blob);
            }
        }

        // Quiz functions
        const quizFeedback = {
            1: {
                correct: "Correct! The cascade starts with nutrient runoff, which triggers algae blooms, then decomposition when algae dies, leading to oxygen depletion.",
                incorrect: "Not quite. Remember: Nutrients FIRST cause algae to grow, THEN decomposition happens AFTER the algae dies, which depletes oxygen."
            },
            2: {
                correct: "Correct! Bacteria are aerobic decomposers - they use oxygen from the water to break down dead organic matter. More dead algae = more bacterial activity = less oxygen.",
                incorrect: "Not quite. The key is that decomposer bacteria CONSUME oxygen during their work. The more dead matter they break down, the more oxygen they use up."
            },
            3: {
                correct: "Correct! Positive feedback means the system amplifies itself. Dead organisms ‚Üí more decomposition ‚Üí less oxygen ‚Üí more deaths ‚Üí even more decomposition. The problem makes itself worse!",
                incorrect: "Remember from Cycle 3: 'Positive' feedback doesn't mean 'good' ‚Äî it means self-amplifying. The dead zone creates more death, which makes the dead zone worse."
            }
        };

        function checkAnswer(btn, isCorrect, qNum) {
            const feedback = document.getElementById('feedback-' + qNum);
            const buttons = btn.parentElement.querySelectorAll('.quiz-btn');

            buttons.forEach(b => {
                b.disabled = true;
                if (b === btn) b.classList.add(isCorrect ? 'correct' : 'incorrect');
            });

            feedback.textContent = isCorrect ? quizFeedback[qNum].correct : quizFeedback[qNum].incorrect;
            feedback.className = 'quiz-feedback show ' + (isCorrect ? 'correct' : 'incorrect');
        }

        function resetQuiz() {
            document.querySelectorAll('.quiz-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('correct', 'incorrect');
            });
            document.querySelectorAll('.quiz-feedback').forEach(fb => {
                fb.className = 'quiz-feedback';
                fb.textContent = '';
            });
        }

        // Initialize
        const slider = document.getElementById('nutrient-slider');
        slider.addEventListener('input', (e) => updateSimulation(parseInt(e.target.value)));

        generateChart();
        updateSimulation(50);

        // Continuous particle animation (respects reduced motion preference)
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (!prefersReducedMotion) {
            setInterval(() => {
                const level = parseInt(slider.value);
                updateNutrientStream(level);
            }, 2000);
        }
    </script>
</body>
</html>
